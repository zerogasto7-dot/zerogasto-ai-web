<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // 1. CONFIGURACIÃ“N
    const API_KEY = "AIzaSyBH8FjvJN8w3_wwKcPhy9xu5cp84lWaMNM"; // AsegÃºrate de que no tenga espacios
    const genAI = new GoogleGenerativeAI(API_KEY);

    // 2. EL MODELO CON EL PROMPT MAESTRO (Tu punto 4)
    const model = genAI.getGenerativeModel({ 
        model: "gemini-1.5-flash",
        // AquÃ­ inyectamos la personalidad de Chef de Aprovechamiento
        systemInstruction: "ActÃºa como un chef experto en cocina de aprovechamiento. Tu misiÃ³n es ayudar a ahorrar y evitar el desperdicio. Inventa recetas creativas con los ingredientes que el usuario te dÃ©. Estructura siempre: 1. Nombre creativo, 2. Tiempo estimado, 3. Instrucciones paso a paso, 4. Tip ZeroGasto para no desperdiciar.",
    });

    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    let isProcessing = false;

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text || isProcessing) return;

        isProcessing = true;
        sendBtn.disabled = true;
        appendMessage('user', text);
        userInput.value = '';

        // Feedback visual de "pensando"
        const loadingId = appendMessage('ai', 'Generando receta mÃ¡gica... ğŸ³');

        try {
            // GeneraciÃ³n de contenido con manejo de errores especÃ­fico
            const result = await model.generateContent(text);
            const response = await result.response;
            const responseText = response.text();
            
            // Reemplazamos el mensaje de carga con la respuesta real
            updateMessage(loadingId, responseText);
            
        } catch (error) {
            console.error("Error detallado:", error);
            let errorMsg = "OcurriÃ³ un error. Revisa tu conexiÃ³n o la API Key.";
            
            if (error.message.includes("429")) {
                errorMsg = "Demasiadas peticiones. Espera un minuto, por favor.";
            } else if (error.message.includes("API key not valid")) {
                errorMsg = "La API Key no es vÃ¡lida. VerifÃ­cala en Google AI Studio.";
            }
            
            updateMessage(loadingId, errorMsg);
        } finally {
            isProcessing = false;
            sendBtn.disabled = false;
        }
    }

    function appendMessage(role, text) {
        const id = Date.now();
        const msgDiv = document.createElement('div');
        msgDiv.id = id;
        msgDiv.className = role === 'user' 
            ? "bg-emerald-600 text-white p-4 rounded-2xl rounded-tr-none max-w-[80%] ml-auto shadow-sm animate-fade-in"
            : "bg-white border border-emerald-100 text-slate-700 p-4 rounded-2xl rounded-tl-none max-w-[80%] shadow-sm whitespace-pre-wrap animate-fade-in";
        msgDiv.innerText = text;
        chatContainer.appendChild(msgDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return id;
    }

    function updateMessage(id, newText) {
        const msgDiv = document.getElementById(id);
        if (msgDiv) msgDiv.innerText = newText;
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
</script>
